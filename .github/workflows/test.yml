name: Java CI with Maven

on:
  pull_request:
    branches:
      - master
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up JDK 17
      uses: actions/setup-java@v2
      with:
        java-version: '17'
        distribution: 'adopt'

    - name: Build with Maven
      run: mvn -B clean verify

    - name: Generate Code Coverage Report
      run: mvn -B jacoco:report

    - name: Extract Code Coverage Information
      id: coverage
      run: |
        COVERAGE=$(sed -n 's/.*Overall coverage rate \([^%]*\)\%.*/\1/p' target/site/jacoco/index.html)
        echo "::set-output name=coverage::$COVERAGE"

    - name: Comment Code Coverage on Pull Request
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v5
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          try {
            const coverage = '${{ steps.coverage.outputs.coverage }}';
            console.log('Coverage:', coverage);

            const payload = JSON.stringify(context.payload, null, 2);
            console.log('Payload:', payload);

            const owner = context.payload.repository?.owner?.login;
            console.log('Owner:', owner);

            const repo = context.payload.repository?.name;
            console.log('Repository:', repo);

            const prNumber = context.payload.pull_request?.number;
            console.log('Pull Request Number:', prNumber);

            if (owner && repo && prNumber) {
              const comment = `Code Coverage: ${coverage}%`;
              github.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: comment
              });
            } else {
              console.error('Unable to extract necessary information to create comment.');
            }
          } catch (error) {
            console.error('Error occurred while commenting on pull request:', error.message);
          }
